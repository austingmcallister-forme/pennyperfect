"use strict";(()=>{var e={};e.id=66,e.ids=[66],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},4325:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>l,originalPathname:()=>h,requestAsyncStorage:()=>u,routeModule:()=>d,serverHooks:()=>c,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>x});var i={};r.r(i),r.d(i,{POST:()=>POST});var n=r(884),a=r(6132),o=r(5798),s=r(7542),p=r(7677);async function POST(e,{params:t}){try{let e=await s._.experiment.findUnique({where:{id:t.id},include:{shop:!0,band:!0,periods:{orderBy:{startedAt:"desc"}}}});if(!e)return o.Z.json({error:"Experiment not found"},{status:404});if("running"!==e.status)return o.Z.json({error:"Experiment is not running"},{status:400});let r=e.periods.reduce((e,t)=>{let r=Number(e.revenueCents)/Math.max(e.sessions,1),i=Number(t.revenueCents)/Math.max(t.sessions,1);return i>r?t:e}),i=await s._.variant.findMany({where:{shopId:e.shopId,priceCents:{gte:e.band.minCents,lte:e.band.maxCents}}});for(let t of i){let i=100*Math.floor(t.priceCents/100)+r.ending;i!==t.priceCents&&(await (0,p.a2)(e.shop.accessTokenEnc,e.shop.domain,t.shopifyVariantId.toString(),(i/100).toFixed(2)),await s._.priceChange.create({data:{shopId:e.shopId,variantId:t.id,experimentId:e.id,oldPriceCents:t.priceCents,newPriceCents:i,reason:"promote"}}),await s._.variant.update({where:{id:t.id},data:{priceCents:i}}))}return await s._.experiment.update({where:{id:t.id},data:{status:"promoted",endedAt:new Date}}),o.Z.json({message:"Experiment promoted successfully"})}catch(e){return console.error("Error promoting experiment:",e),o.Z.json({error:"Failed to promote experiment"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/experiments/[id]/promote/route",pathname:"/api/experiments/[id]/promote",filename:"route",bundlePath:"app/api/experiments/[id]/promote/route"},resolvedPagePath:"/Users/austinmcallister/pennyperfect/src/app/api/experiments/[id]/promote/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:u,staticGenerationAsyncStorage:m,serverHooks:c,headerHooks:l,staticGenerationBailout:x}=d,h="/api/experiments/[id]/promote/route"},7542:(e,t,r)=>{r.d(t,{_:()=>a});let i=require("@prisma/client"),n=globalThis,a=n.prisma??new i.PrismaClient}};var t=require("../../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[997,543,677],()=>__webpack_exec__(4325));module.exports=r})();