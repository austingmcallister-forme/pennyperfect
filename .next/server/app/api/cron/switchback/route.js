"use strict";(()=>{var e={};e.id=245,e.ids=[245],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},2061:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>m,requestAsyncStorage:()=>p,routeModule:()=>c,serverHooks:()=>u,staticGenerationAsyncStorage:()=>l,staticGenerationBailout:()=>w});var n={};r.r(n),r.d(n,{GET:()=>GET});var a=r(884),i=r(6132),s=r(5798),o=r(7542),d=r(7677);function roundDownToEnding(e,t){return Math.round(100*(Math.floor(e/100)+t/100))}function getNextEnding(e,t){let r=t.indexOf(e),n=(r+1)%t.length;return t[n]}function calculateRPV(e,t){if(0===t)return 0;let r="bigint"==typeof e?Number(e):e;return r/t}async function GET(e){let t=e.headers.get("authorization");if(t!==`Bearer ${process.env.CRON_SECRET}`)return s.Z.json({error:"Unauthorized"},{status:401});try{let e=await o._.experiment.findMany({where:{status:"running"},include:{shop:!0,band:!0,periods:{where:{endedAt:null},orderBy:{startedAt:"desc"}}}});for(let t of e){let e=t.periods[0];if(!e){let e=t.band.allowedEndings[0];await startNewPeriod(t,e);continue}let r=Date.now()-e.startedAt.getTime(),n=36e5*t.cadenceHours;if(r>=n){await o._.experimentPeriod.update({where:{id:e.id},data:{endedAt:new Date}});let r=getNextEnding(e.ending,t.band.allowedEndings);await startNewPeriod(t,r),await checkExperimentPerformance(t)}}return s.Z.json({message:"Switchback cron completed"})}catch(e){return console.error("Error in switchback cron:",e),s.Z.json({error:"Cron job failed"},{status:500})}}async function startNewPeriod(e,t){await o._.experimentPeriod.create({data:{experimentId:e.id,ending:t,startedAt:new Date}});let r=await o._.variant.findMany({where:{shopId:e.shopId,priceCents:{gte:e.band.minCents,lte:e.band.maxCents}}});for(let n of r){let r=roundDownToEnding(n.priceCents,t);r!==n.priceCents&&(await o._.priceChange.create({data:{shopId:e.shopId,variantId:n.id,experimentId:e.id,oldPriceCents:n.priceCents,newPriceCents:r,reason:"switchback"}}),await (0,d.a2)(e.shop.accessTokenEnc,e.shop.domain,n.shopifyVariantId.toString(),(r/100).toFixed(2)),await o._.variant.update({where:{id:n.id},data:{priceCents:r}}))}}async function checkExperimentPerformance(e){let t=await o._.experimentPeriod.findMany({where:{experimentId:e.id,endedAt:{not:null}},orderBy:{startedAt:"asc"}});if(t.length<e.minCycles)return;let r=new Map;for(let e of t){let t=calculateRPV(Number(e.revenueCents),e.sessions),n=r.get(e.ending)||{rpv:0,sessions:0};r.set(e.ending,{rpv:n.rpv+t,sessions:n.sessions+e.sessions})}let n=-1,a=-1;for(let[e,t]of r){let r=t.rpv/Math.max(t.sessions,1);r>a&&(a=r,n=e)}let i=Math.min(...Array.from(r.values()).map(e=>e.rpv/Math.max(e.sessions,1))),s=(a-i)/i;if(s>=e.revertThresholdRpv){await o._.experiment.update({where:{id:e.id},data:{status:"promoted",endedAt:new Date}});let t=await o._.variant.findMany({where:{shopId:e.shopId,priceCents:{gte:e.band.minCents,lte:e.band.maxCents}}});for(let r of t){let t=roundDownToEnding(r.priceCents,n);t!==r.priceCents&&(await o._.priceChange.create({data:{shopId:e.shopId,variantId:r.id,experimentId:e.id,oldPriceCents:r.priceCents,newPriceCents:t,reason:"promote"}}),await (0,d.a2)(e.shop.accessTokenEnc,e.shop.domain,r.shopifyVariantId.toString(),(t/100).toFixed(2)),await o._.variant.update({where:{id:r.id},data:{priceCents:t}}))}}else s<-e.revertThresholdRpv&&await o._.experiment.update({where:{id:e.id},data:{status:"reverted",endedAt:new Date}})}let c=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/cron/switchback/route",pathname:"/api/cron/switchback",filename:"route",bundlePath:"app/api/cron/switchback/route"},resolvedPagePath:"/Users/austinmcallister/pennyperfect/src/app/api/cron/switchback/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:l,serverHooks:u,headerHooks:h,staticGenerationBailout:w}=c,m="/api/cron/switchback/route"},7542:(e,t,r)=>{r.d(t,{_:()=>i});let n=require("@prisma/client"),a=globalThis,i=a.prisma??new n.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[997,543,677],()=>__webpack_exec__(2061));module.exports=r})();